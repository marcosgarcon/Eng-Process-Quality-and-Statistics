<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Eng Process & Quality - Mapeamento VSM (Pro)</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root{
        --bg:#0f172a; --panel:#111827; --muted:#1f2937; --card:#0b1220; --text:#e5e7eb; --accent:#22d3ee; --accent2:#a78bfa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
        --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial; background:linear-gradient(120deg,#0b1020,#0a1328); color:var(--text); display:grid; grid-template-columns:320px 1fr; grid-template-rows:auto 1fr; gap:0; }
      header{grid-column:1/3; display:flex; align-items:center; justify-content:space-between; padding:14px 20px; background:linear-gradient(90deg,#0b1020,#0a1a35); border-bottom:1px solid #1e293b; position:sticky; top:0; z-index:5}
      .header-title h1 { margin: 0; font-size: 20px; letter-spacing: .4px; color: var(--text); }
      .header-title .subtitle { margin: 4px 0 0 0; font-size: 14px; font-weight: normal; color: var(--accent); }
      .header-title .dev-credit { margin: 4px 0 0 0; font-size: 11px; font-weight: normal; color: #64748b; }
      header .actions{display:flex; flex-wrap: wrap; gap:8px; align-items:center}
      button, .btn{background:var(--muted); color:var(--text); border:1px solid #243041; border-radius:12px; padding:10px 14px; cursor:pointer; box-shadow:var(--shadow); transition:.2s; font-weight:600}
      button:hover, .btn:hover{transform:translateY(-1px); border-color:#334155}
      button.primary, .btn.primary{background:linear-gradient(180deg,#0ea5e9,#2563eb); border-color:transparent}
      button.ghost, .btn.ghost{background:transparent; border-color:#334155}
      aside{border-right:1px solid #1f2937; background:linear-gradient(180deg,#0b1020,#0a1328); padding:16px; display:flex; flex-direction:column; gap:18px; justify-content: flex-start;}
      .menu a{display:flex; gap:10px; align-items:center; text-decoration:none; color:#cbd5e1; padding:10px 12px; border:1px solid #1e293b; border-radius:12px; background:rgba(255,255,255,.02); cursor:pointer;}
      .menu a.active,.menu a:hover{border-color:#334155; background:rgba(34,211,238,.08); color:#e2e8f0}
      main{padding:18px; overflow:auto}
      section{background:rgba(255,255,255,.03); border:1px solid #1f2937; border-radius:var(--radius); padding:16px; margin-bottom:18px; box-shadow:var(--shadow)}
      h2, h3{margin:0 0 12px 0; font-size:18px; color: var(--accent);}
      .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
      .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3}
      .field{display:flex; flex-direction:column; gap:6px}
      label{font-size:12px; color:#93c5fd}
      input, select, textarea{background:#0b1220; border:1px solid #243041; color:var(--text); padding:10px 12px; border-radius:10px; outline:none; font-family:inherit;
font-size:14px;}
      table { width: 100%; border-collapse: collapse; margin-top: 12px; }
      th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--muted); font-size: 14px; vertical-align: middle; }
      th { color: var(--accent2); font-size: 12px; }
      td input { width: 100%; padding: 6px; background:transparent; border:none; color:var(--text); outline:none; }
      .remove-step-btn { background: none; border: none; color: var(--bad); font-size: 20px; cursor: pointer; padding:0; box-shadow: none; }
      .dashboard-card { background-color: var(--card); padding: 16px; border-radius: 12px; text-align: center; border: 1px solid var(--muted); }
      .dashboard-card .value { font-size: 28px; font-weight: bold; color: var(--accent2); margin-bottom: 8px; }
      .dashboard-card .label { font-size: 12px; color: #93c5fd; }
      #record-counter { background:rgba(255,255,255,.02); border:1px solid #1e293b; border-radius: 12px; padding: 12px;}
      #record-counter p { margin: 8px 0; color: #cbd5e1; display: flex; justify-content: space-between; }
      #record-counter span { font-weight: bold; color: var(--accent); }
      .toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
      .toast { padding: 12px 18px; border-radius: 12px; color: white; font-weight: 600; font-size: 14px; box-shadow: var(--shadow); opacity: 0; transform: translateX(100%); transition: all 0.4s ease; }
      .toast.show { opacity: 1; transform: translateX(0); }
      .toast.success { background: linear-gradient(90deg, #22c55e, #16a34a); } .toast.error { background: linear-gradient(90deg, #ef4444, #dc2626); } .toast.info { background: linear-gradient(90deg, #3b82f6, #2563eb); }
      .action-item-block { padding: 12px; border: 1px solid var(--muted); border-radius: 12px; background: var(--card); position: relative; margin-top: 10px; }
      .remove-action-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; color: #fca5a5; font-size: 1.5rem; cursor: pointer;}
      .attachments-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--muted); }
      .attachment-drop-zone { padding: 10px; font-size: 12px; margin-top: 5px; border: 2px dashed var(--muted); text-align: center; cursor: pointer; border-radius: 8px;}
      .attachment-drop-zone:hover { border-color: var(--accent); }
      .attachment-preview-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
      .attachment-item { width: 80px; height: 80px; position: relative; }
      .attachment-item img, .attachment-item .file-icon { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
      .attachment-item .file-icon { background: var(--muted); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-size: 11px; padding: 5px; overflow: hidden; word-break: break-all; }
      .attachment-item .file-icon span { font-size: 24px; }
      .attachment-item .remove-attachment { position: absolute; top: -5px; right: -5px; background: var(--bad); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1;}
      .hidden { display: none !important; }
      .history-list { max-height: 300px; overflow:auto; display:flex; flex-direction:column; gap:8px; margin-top:8px; }
      .history-item { display:flex; justify-content:space-between; gap:8px; align-items:center; padding:8px; border-radius:8px; border:1px solid var(--muted); background: rgba(255,255,255,.02); }
      .history-item .meta { font-size:12px; color:#93c5fd; }
      .last-saved { font-size:12px; color:#93c5fd; margin-left:8px; }

      @media(max-width:980px){body{grid-template-columns:1fr} aside{display:none}}
      @media print { body { display: block; grid-template-columns: 1fr; } header, aside, .btn, .remove-step-btn, .hidden-print, .remove-action-btn, .remove-attachment { display: none !important; } main { padding: 0; overflow: visible;} section { box-shadow: none; border: 1px solid #ccc; background: white; color: black; page-break-inside: avoid; } input, select, textarea { border: 1px solid #ccc; color: black; background: #f9f9f9;} label, h2, h3, h4, .dashboard-card .value
{ color: black !important; } .dashboard-card { background: #eee; }}
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <header>
        <div class="header-title">
            <h1>Eng Process & Quality</h1>
            <p class="subtitle">Mapeamento de Fluxo de Valor (VSM)</p>
            <p class="dev-credit">Desenvolvido por Marcos Gar√ßon<span class="last-saved" id="last-saved-display"></span></p>
        </div>
        <div class="actions">
            <button class="btn ghost" id="btn-restore-backup">Restaurar Backup</button>
            <button class="btn ghost" id="btn-download-backup">Baixar Backup (.json)</button>
            <button class="btn ghost" id="btn-save-analysis">Salvar An√°lise</button>
            <button class="btn ghost" id="btn-new-analysis" title="Criar nova an√°lise mantendo hist√≥rico">Nova An√°lise</button>
            <button class="btn ghost" id="btn-archive-and-clear" style="color:var(--warn);">Arquivar e Limpar</button>
            <button class="btn primary" id="btn-export-pdf">Exportar PDF (Imprimir)</button>
        </div>
    </header>

    <aside>
        <div id="record-counter">
            <h4>Registros do Mapa</h4>
            <p>Etapas do Processo: <span id="vsm-steps-count">0</span></p>
            <p>√öltima grava√ß√£o: <span id="last-saved-mini">‚Äî</span></p>
            <p>Auto-save: <span id="autosave-status">Ativado (2 min)</span></p>
        </div>

        <div>
            <h4>Hist√≥rico de An√°lises</h4>
            <div class="history-list" id="history-list"></div>
            <div style="margin-top:10px;">
                <button class="btn ghost" id="btn-clear-history" title="Apaga todo hist√≥rico salvo">Limpar Hist√≥rico</button>
            </div>
        </div>
    </aside>

    <main>
        <form id="vsm-form">
            <section>
                <h2>Informa√ß√µes do Mapa</h2>
                 <div class="grid">
                    <div class="col-4 field"><label for="projectName">Nome do Projeto/Produto</label><input type="text" id="projectName" placeholder="Nome do projeto"></div>
                    <div class="col-4 field"><label for="vsmId">ID do Mapa</label><input type="text" id="vsmId" readonly></div>
                    <div class="col-4 field"><label for="responsible">Respons√°vel</label><input type="text" id="responsible"></div>
                 </div>
            </section>
            
            <section>
                <h2>Dados do Cliente e Takt Time</h2>
                <div class="grid">
                    <div class="col-4 field"><label for="vsm-demand">Demanda (un/dia)</label><input type="number" id="vsm-demand" value="460"></div>
                    <div class="col-4 field"><label for="vsm-time">Tempo Dispon√≠vel (s/dia)</label><input type="number" id="vsm-time" value="28800"></div>
                    <div class="col-4 field"><label for="vsm-takt">Takt Time (calculado)</label><input type="text" id="vsm-takt" readonly style="color: var(--accent); font-weight: bold;"></div>
                </div>
            </section>
            
            <section>
                <h2>Etapas do Processo</h2>
                <div style="overflow-x: auto;">
                    <table id="vsm-steps-table">
                        <thead>
                          <tr>
                            <th>Nome do Processo</th>
                            <th>C/T (s)</th>
                            <th>TAV (s)</th>
                            <th>C/O (s)</th>
                            <th>Uptime (%)</th>
                            <th>WIP (un)</th>
                            <th>Dist√¢ncia (m)</th>
                            <th>Efici√™ncia (%)</th>
                            <th class="hidden-print">A√ß√£o</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button id="add-vsm-step" type="button" class="btn ghost" style="width:100%; margin-top:12px;">+ Adicionar Etapa</button>
            </section>

            <section>
                <h2>Resultados do Fluxo de Valor</h2>
                <div class="grid">
                    <div class="col-3"><div class="dashboard-card"><div class="value" id="vsm-total-ct">0 s</div><div class="label">Tempo de Ciclo Total</div></div></div>
                    <div class="col-3"><div class="dashboard-card"><div class="value" id="vsm-total-lt">0 s</div><div class="label">Lead Time de Produ√ß√£o</div></div></div>
                    <div class="col-3"><div class="dashboard-card"><div class="value" id="vsm-total-tav">0 s</div><div class="label">Tempo Total que Agrega Valor</div></div></div>
                    <div class="col-3"><div class="dashboard-card"><div class="value" id="vsm-pce" style="color:var(--ok);">0 %</div><div class="label">Efici√™ncia do Ciclo (PCE)</div></div></div>
                </div>
            </section>
            
            <section>
                <h2>An√°lise Gr√°fica: C/T vs. TAV</h2>
                <canvas id="vsm-chart"></canvas>
            </section>
            
            <section>
                 <h2>Planos de A√ß√£o para Melhoria do Fluxo</h2>
                 <div id="action-plan-form-container"></div>
                 <button type="button" id="btn-add-action-plan" class="btn ghost" style="width:100%; margin-top:12px;">+ Adicionar Plano de A√ß√£o</button>
            </section>
        </form>
    </main>
    
    <template id="attachment-ui-template">
        <div class="field">
             <input type="file" class="attachments-input hidden" multiple>
             <div class="attachment-drop-zone">Arraste ou clique para adicionar arquivos (m√°x 5MB)</div>
             <div class="attachment-preview-grid"></div>
        </div>
    </template>

    <template
id="action-plan-form-template">
        <div class="action-item-block">
            <button type="button" class="remove-action-btn hidden-print">&times;</button>
            <div class="grid">
                <div class="field" style="grid-column: span 12;"><label>A√ß√£o / Pend√™ncia</label><textarea class="action-input" rows="2"></textarea></div>
                <div class="field" style="grid-column: span 3;"><label>Respons√°vel</label><input type="text" class="responsible-input"></div>
                <div class="field" style="grid-column: span 3;"><label>Status</label><select class="status-input"><option value="aberto">Aberto</option><option value="andamento">Em Andamento</option><option value="concluido">Conclu√≠do</option><option value="cancelado">Cancelado</option></select></div>
                <div class="field" style="grid-column: span 3;"><label>Data In√≠cio</label><input type="date" class="start-date-input"></div>
                <div class="field" style="grid-column: span 3;"><label>Data Final</label><input type="date" class="end-date-input"></div>
                <div class="field" style="grid-column: span 12; border-top: 1px solid var(--muted); padding-top: 12px; margin-top: 6px;">
                    <label>Anexos</label>
                    <div class="attachments-section" style="border-top: none; padding-top: 0; margin-top: 0;"></div>
                </div>
            </div>
        </div>
    </template>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & DB KEYS ---
        const DB_KEY = 'mg_vsm_v2_actions'; // autosave / current
        const ARCHIVE_KEY = 'mg_vsm_v2_archive'; // saved analyses collection
        const AUTO_SAVE_INTERVAL_MS = 2 * 60 * 1000; // 2 minutes

        let vsmChart = null;
        let autosaveTimer = null;

        // --- DOM ELEMENTS ---
        const mainContainer = document.querySelector('main');
        const form = document.getElementById('vsm-form');
        const tableBody = document.querySelector('#vsm-steps-table tbody');
        const actionPlanFormContainer = document.getElementById('action-plan-form-container');
        const btnAddActionPlan = document.getElementById('btn-add-action-plan');
        const actionPlanFormTemplate = document.getElementById('action-plan-form-template');
        const attachmentUiTemplate = document.getElementById('attachment-ui-template');
        const historyList = document.getElementById('history-list');
        const lastSavedDisplay = document.getElementById('last-saved-display');
        const lastSavedMini = document.getElementById('last-saved-mini');

        // --- HELPERS ---
        const fmtNow = (d=new Date()) => d.toLocaleString('pt-BR', { hour12:false });
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 3500);
        };

        // --- DATA HANDLING ---
        const gatherFormData = () => {
            const data = { meta:{}, header: {}, takt: {}, steps: [], actionPlans: [], savedAt: new Date().toISOString() };
            data.meta.version = 'vsm_pro_2025';
            document.querySelectorAll('#projectName, #vsmId, #responsible').forEach(el => data.header[el.id] = el.value);
            document.querySelectorAll('#vsm-demand, #vsm-time').forEach(el => data.takt[el.id] = el.value);

            tableBody.querySelectorAll('tr').forEach(row => {
                const step = {};
                row.querySelectorAll('input').forEach(input => {
                    const key = input.dataset.field;
                    if (key) step[key] = input.value;
                });
                // compute efficiency stored for convenience
                const ct = parseFloat(step.ct) || 0;
                const tav = parseFloat(step.tav) || 0;
                step.efficiency = ct > 0 ? ((tav / ct) * 100).toFixed(2) : '0.00';
                data.steps.push(step);
            });

            actionPlanFormContainer.querySelectorAll('.action-item-block').forEach(block => {
                data.actionPlans.push({
                    action: block.querySelector('.action-input').value,
                    responsible: block.querySelector('.responsible-input').value,
                    status: block.querySelector('.status-input').value,
                    startDate: block.querySelector('.start-date-input').value,
                    endDate: block.querySelector('.end-date-input').value,
                    attachments: getAttachmentsFromContainer(block.querySelector('.attachments-section'))
                });
            });

            return data;
        };

        const saveToLocal = (key, value) => {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch(e) {
                console.error('Erro gravando localStorage', e);
                return false;
            }
        };
        const loadFromLocal = (key) => {
            const raw = localStorage.getItem(key);
            if (!raw) return null;
            try { return JSON.parse(raw); } catch(e) { return null; }
        };

        const saveAutosave = () => {
            const data = gatherFormData();
            saveToLocal(DB_KEY, data);
            const now = fmtNow();
            lastSavedDisplay.textContent = ` ‚Ä¢ √öltima grava√ß√£o: ${now}`;
            lastSavedMini.textContent = now;
            showToast('Auto-save realizado', 'info');
        };

        const saveAnalysisDialog = () => {
            const data = gatherFormData();
            const defaultName = `${data.header.projectName || 'An√°lise'} - ${new Date().toISOString().slice(0,10)}`;
            const name = prompt('Nome para salvar a an√°lise (usado no hist√≥rico):', defaultName);
            if (!name) { showToast('Salvar cancelado', 'error'); return; }
            saveAnalysis(name, data);
        };

        const saveAnalysis = (name, dataObj = null) => {
            const archive = loadFromLocal(ARCHIVE_KEY) || {};
            const key = `vsm_${new Date().toISOString()}`;
            const data = dataObj || gatherFormData();
            data.savedName = name;
            data.savedAt = new Date().toISOString();
            archive[key] = data;
            if (saveToLocal(ARCHIVE_KEY, archive)) {
                showToast('An√°lise salva no hist√≥rico', 'success');
                renderHistoryList();
                // also update autosave DB and last saved
                saveToLocal(DB_KEY, data);
                const now = fmtNow();
                lastSavedDisplay.textContent = ` ‚Ä¢ √öltima grava√ß√£o: ${now}`;
                lastSavedMini.textContent = now;
            } else {
                showToast('Erro ao salvar an√°lise.', 'error');
            }
        };

        const deleteAnalysis = (key) => {
            if (!confirm('Deseja excluir permanentemente esta an√°lise do hist√≥rico?')) return;
            const archive = loadFromLocal(ARCHIVE_KEY) || {};
            delete archive[key];
            saveToLocal(ARCHIVE_KEY, archive);
            renderHistoryList();
            showToast('An√°lise exclu√≠da', 'info');
        };

        const openAnalysis = (key) => {
            const archive = loadFromLocal(ARCHIVE_KEY) || {};
            const data = archive[key];
            if (!data) { showToast('An√°lise n√£o encontrada', 'error'); return; }
            if (confirm('Abrir esta an√°lise substituir√° os dados atuais no formul√°rio. Deseja continuar?')) {
                populateForm(data);
                saveToLocal(DB_KEY, data);
                const now = fmtNow();
                lastSavedDisplay.textContent = ` ‚Ä¢ √öltima grava√ß√£o: ${now}`;
                lastSavedMini.textContent = now;
                showToast('An√°lise carregada', 'success');
            }
        };

        const exportBackup = () => {
            const blob = new Blob([JSON.stringify({current: loadFromLocal(DB_KEY), archive: loadFromLocal(ARCHIVE_KEY)}, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `vsm_full_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
            link.click();
            URL.revokeObjectURL(link.href);
            showToast('Backup gerado!', 'success');
        };

        const restoreBackupFile = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = ev => {
                    try {
                        const obj = JSON.parse(ev.target.result);
                        if (obj.current) saveToLocal(DB_KEY, obj.current);
                        if (obj.archive) saveToLocal(ARCHIVE_KEY, obj.archive);
                        populateForm(obj.current || {});
                        renderHistoryList();
                        showToast('Backup restaurado!', 'success');
                    } catch(err) {
                        console.error(err);
                        showToast('Arquivo inv√°lido.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        const archiveAndClear = () => {
            if (!confirm("ATEN√á√ÉO: Isso ir√° baixar um backup e APAGAR os dados do navegador. Deseja continuar?")) return;
            exportBackup();
            localStorage.removeItem(DB_KEY);
            localStorage.removeItem(ARCHIVE_KEY);
            showToast("Dados arquivados e limpos.", "info");
            setTimeout(() => window.location.reload(), 800);
        };

        // --- UI Populate / Render ---
        const populateForm = (data) => {
            if (!data) return;
            if (data.header) {
                for (const key in data.header) {
                    const el = document.getElementById(key);
                    if (el) el.value = data.header[key];
                }
            }
            if (data.takt) {
                for (const key in data.takt) {
                    const el = document.getElementById(key);
                    if (el) el.value = data.takt[key];
                }
            }
            tableBody.innerHTML = '';
            if (data.steps && data.steps.length) {
                data.steps.forEach(stepData => {
                    const row = addStepRow(false);
                    for (const k in stepData) {
                        const input = row.querySelector(`[data-field="${k}"]`);
                        if (input) input.value = stepData[k];
                    }
                });
            }
            renderActionPlans(data.actionPlans || []);
            calculateAndDisplayVSM();
        };

        const renderActionPlans = (plansData = []) => {
            actionPlanFormContainer.innerHTML = '';
            if (!plansData || plansData.length === 0) return;
            plansData.forEach(plan => {
                const clone = actionPlanFormTemplate.content.cloneNode(true);
                const block = clone.querySelector('.action-item-block');
                block.querySelector('.action-input').value = plan.action || '';
                block.querySelector('.responsible-input').value = plan.responsible || '';
                block.querySelector('.status-input').value = plan.status || 'aberto';
                block.querySelector('.start-date-input').value = plan.startDate || '';
                block.querySelector('.end-date-input').value = plan.endDate || '';
                const attachmentsContainer = block.querySelector('.attachments-section');
                attachmentsContainer.appendChild(attachmentUiTemplate.content.cloneNode(true));
                if (plan.attachments && plan.attachments.length > 0) {
                    const grid = attachmentsContainer.querySelector('.attachment-preview-grid');
                    plan.attachments.forEach(att => addAttachmentPreview(grid, att));
                }
                actionPlanFormContainer.appendChild(clone);
            });
        };

        const addAttachmentPreview = (gridContainer, fileData) => {
            const previewItem = document.createElement('div');
            previewItem.className = 'attachment-item';
            previewItem.dataset.fileName = fileData.name;
            previewItem.dataset.fileData = fileData.data;
            previewItem.dataset.fileType = fileData.type;
            let previewContent = (fileData.type && fileData.type.startsWith('image/')) ? `<img src="${fileData.data}" alt="${fileData.name}" title="${fileData.name}">` : `<div class="file-icon" title="${fileData.name}"><span>üìÑ</span>${fileData.name}</div>`;
            previewItem.innerHTML = `${previewContent}<button type="button" class="remove-attachment">&times;</button>`;
            gridContainer.appendChild(previewItem);
        };

        const handleFiles = (files, container) => {
            const grid = container.querySelector('.attachment-preview-grid');
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) { showToast(`Arquivo "${file.name}" √© maior que 5MB.`, 'error'); continue; }
                const reader = new FileReader();
                reader.onload = (e) => addAttachmentPreview(grid, { name: file.name, type: file.type || 'application/octet-stream', data: e.target.result });
                reader.readAsDataURL(file);
            }
        };

        const getAttachmentsFromContainer = (container) => {
            const attachments = [];
            container.querySelectorAll('.attachment-item').forEach(item => attachments.push({ name: item.dataset.fileName, type: item.dataset.fileType, data: item.dataset.fileData }));
            return attachments;
        };

        // --- VSM LOGIC ---
        const addStepRow = (shouldCalculate = true) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" data-field="processName" placeholder="Ex: Montagem"></td>
                <td><input type="number" data-field="ct" value="0" min="0"></td>
                <td><input type="number" data-field="tav" value="0" min="0"></td>
                <td><input type="number" data-field="co" value="0" min="0"></td>
                <td><input type="number" data-field="uptime" value="100" min="0" max="100"></td>
                <td><input type="number" data-field="wip" value="0" min="0"></td>
                <td><input type="number" data-field="distance" value="0" min="0"></td>
                <td><input type="text" data-field="efficiency" value="0.00" readonly></td>
                <td class="hidden-print"><button type="button" class="remove-step-btn" title="Remover etapa">&times;</button></td>
            `;
            tableBody.appendChild(row);
            if (shouldCalculate) { calculateAndDisplayVSM(); saveToLocal(DB_KEY, gatherFormData()); }
            return row;
        };

        const calculateAndDisplayVSM = () => {
            const demand = parseFloat(document.getElementById('vsm-demand').value) || 0;
            const time = parseFloat(document.getElementById('vsm-time').value) || 0;
            const taktTime = demand > 0 ? time / demand : 0;
            document.getElementById('vsm-takt').value = `${taktTime.toFixed(2)} s/un`;

            let totalCT = 0, totalTAV = 0, totalWIP = 0;
            const stepDataForChart = { labels: [], ct: [], tav: [] };

            tableBody.querySelectorAll('tr').forEach(row => {
                const ct = parseFloat(row.querySelector('[data-field="ct"]').value) || 0;
                const tav = parseFloat(row.querySelector('[data-field="tav"]').value) || 0;
                const wip = parseFloat(row.querySelector('[data-field="wip"]').value) || 0;
                const processName = row.querySelector('[data-field="processName"]').value || 'Etapa';
                totalCT += ct;
                totalTAV += tav;
                totalWIP += wip;
                stepDataForChart.labels.push(processName);
                stepDataForChart.ct.push(ct);
                stepDataForChart.tav.push(tav);

                const eff = ct > 0 ? ((tav / ct) * 100) : 0;
                const effInput = row.querySelector('[data-field="efficiency"]');
                if (effInput) effInput.value = eff.toFixed(2);
                // color code row slightly based on efficiency
                row.style.background = eff >= 90 ? 'linear-gradient(90deg, rgba(34,197,94,0.04), transparent)' : (eff >= 60 ? 'linear-gradient(90deg, rgba(245,158,11,0.03), transparent)' : 'linear-gradient(90deg, rgba(239,68,68,0.03), transparent)');
            });

            const leadTime = (totalWIP * taktTime) + totalCT;
            const pce = leadTime > 0 ? (totalTAV / leadTime) * 100 : 0;

            document.getElementById('vsm-total-ct').textContent = `${totalCT.toFixed(2)} s`;
            document.getElementById('vsm-total-lt').textContent = `${leadTime.toFixed(2)} s`;
            document.getElementById('vsm-total-tav').textContent = `${totalTAV.toFixed(2)} s`;
            document.getElementById('vsm-pce').textContent = `${pce.toFixed(2)} %`;
            document.getElementById('vsm-steps-count').textContent = tableBody.rows.length;

            updateChart(stepDataForChart);
        };

        const updateChart = (data) => {
            const ctx = document.getElementById('vsm-chart').getContext('2d');
            if (vsmChart) vsmChart.destroy();
            vsmChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        { label: 'Tempo de Ciclo (C/T)', data: data.ct, backgroundColor: 'rgba(167, 139, 250, 0.6)', borderColor: 'rgba(167, 139, 250, 1)', borderWidth: 1 },
                        { label: 'Tempo que Agrega Valor (TAV)', data: data.tav, backgroundColor: 'rgba(34, 211, 238, 0.6)', borderColor: 'rgba(34, 211, 238, 1)', borderWidth: 1 }
                    ]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { color: 'var(--text)' } },
                        x: { ticks: { color: 'var(--text)' } }
                    },
                    plugins: { legend: { labels: { color: 'var(--text)' } } }
                }
            });
        };

        // --- HISTORY UI ---
        const renderHistoryList = () => {
            historyList.innerHTML = '';
            const archive = loadFromLocal(ARCHIVE_KEY) || {};
            const keys = Object.keys(archive).sort((a,b)=> (archive[a].savedAt < archive[b].savedAt ? 1:-1));
            if (!keys.length) {
                historyList.innerHTML = '<div style="font-size:13px;color:#94a3b8">Nenhuma an√°lise salva ainda.</div>';
                return;
            }
            keys.forEach(key => {
                const item = archive[key];
                const el = document.createElement('div');
                el.className = 'history-item';
                const left = document.createElement('div');
                left.innerHTML = `<div style="font-weight:700">${item.savedName || 'Sem nome'}</div><div class="meta">${new Date(item.savedAt).toLocaleString('pt-BR', {hour12:false})} ‚Äî ${item.header && item.header.projectName ? item.header.projectName : ''}</div>`;
                const right = document.createElement('div');
                right.style.display='flex';
                right.style.gap='6px';
                const openBtn = document.createElement('button'); openBtn.className='btn ghost'; openBtn.style.padding='6px 8px'; openBtn.textContent='Abrir';
                openBtn.addEventListener('click',()=>openAnalysis(key));
                const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.style.padding='6px 8px'; delBtn.style.color='var(--bad)'; delBtn.textContent='Excluir';
                delBtn.addEventListener('click',()=>deleteAnalysis(key));
                right.appendChild(openBtn); right.appendChild(delBtn);
                el.appendChild(left); el.appendChild(right);
                historyList.appendChild(el);
            });
        };

        // --- EVENT LISTENERS ---
        form.addEventListener('input', () => { calculateAndDisplayVSM(); saveToLocal(DB_KEY, gatherFormData()); });

        document.getElementById('add-vsm-step').addEventListener('click', () => addStepRow());
        btnAddActionPlan.addEventListener('click', () => {
            const clone = actionPlanFormTemplate.content.cloneNode(true);
            const attachmentsContainer = clone.querySelector('.attachments-section');
            attachmentsContainer.appendChild(attachmentUiTemplate.content.cloneNode(true));
            actionPlanFormContainer.appendChild(clone);
        });

        mainContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-step-btn')) { e.target.closest('tr').remove(); calculateAndDisplayVSM(); saveToLocal(DB_KEY, gatherFormData()); }
            if (e.target.classList.contains('remove-action-btn')) { e.target.closest('.action-item-block').remove(); saveToLocal(DB_KEY, gatherFormData()); }
            if (e.target.classList.contains('attachment-drop-zone')) { e.target.previousElementSibling.click(); }
            if (e.target.classList.contains('remove-attachment')) { e.target.closest('.attachment-item').remove(); saveToLocal(DB_KEY, gatherFormData()); }
        });

        mainContainer.addEventListener('change', e => {
            if (e.target.classList.contains('attachments-input')) {
                handleFiles(e.target.files, e.target.closest('.field, .attachments-section'));
                saveToLocal(DB_KEY, gatherFormData());
            }
        });

        document.getElementById('btn-download-backup').addEventListener('click', exportBackup);
        document.getElementById('btn-restore-backup').addEventListener('click', restoreBackupFile);
        document.getElementById('btn-archive-and-clear').addEventListener('click', archiveAndClear);
        document.getElementById('btn-export-pdf').addEventListener('click', () => window.print());
        document.getElementById('btn-save-analysis').addEventListener('click', saveAnalysisDialog);
        document.getElementById('btn-new-analysis').addEventListener('click', () => {
            if (!confirm('Criar nova an√°lise limpar√° o formul√°rio atual. Deseja salvar o atual antes de continuar?')) {
                // user chose not to save - proceed to new after confirmation to clear
                if (confirm('Deseja criar nova an√°lise (os dados atuais ser√£o perdidos)?')) {
                    newAnalysis();
                }
                return;
            }
            // prompt to save current
            saveAnalysisDialog();
            newAnalysis();
        });

        document.getElementById('btn-clear-history').addEventListener('click', () => {
            if (!confirm('Deseja apagar TODO o hist√≥rico de an√°lises?')) return;
            localStorage.removeItem(ARCHIVE_KEY);
            renderHistoryList();
            showToast('Hist√≥rico limpo', 'info');
        });

        // --- New Analysis ---
        const newAnalysis = () => {
            // generate ID
            const now = new Date();
            const id = `VSM-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
            // clear form
            document.getElementById('projectName').value = '';
            document.getElementById('vsmId').value = id;
            document.getElementById('responsible').value = '';
            document.getElementById('vsm-demand').value = 460;
            document.getElementById('vsm-time').value = 28800;
            tableBody.innerHTML = '';
            actionPlanFormContainer.innerHTML = '';
            // add one empty row
            addStepRow(false);
            calculateAndDisplayVSM();
            saveToLocal(DB_KEY, gatherFormData());
            showToast('Nova an√°lise criada', 'success');
        };

        // --- INIT / BOOT ---
        const initApp = () => {
            // render history
            renderHistoryList();

            // load current DB if present
            const data = loadFromLocal(DB_KEY);
            if (data) {
                populateForm(data);
                const now = fmtNow(new Date(data.savedAt || Date.now()));
                lastSavedDisplay.textContent = ` ‚Ä¢ √öltima grava√ß√£o: ${now}`;
                lastSavedMini.textContent = now;
            } else {
                // initialize with a new ID and one row
                newAnalysis();
            }

            calculateAndDisplayVSM();

            // start autosave
            autosaveTimer = setInterval(() => {
                saveAutosave();
            }, AUTO_SAVE_INTERVAL_MS);

            // quick initial autosave to set timestamp
            saveToLocal(DB_KEY, gatherFormData());
            const now = fmtNow();
            lastSavedDisplay.textContent = ` ‚Ä¢ √öltima grava√ß√£o: ${now}`;
            lastSavedMini.textContent = now;
        };

        // cleanup on unload
        window.addEventListener('beforeunload', () => {
            // ensure current data saved
            saveToLocal(DB_KEY, gatherFormData());
        });

        // kick off
        initApp();
    });
    </script>
</body>
</html>